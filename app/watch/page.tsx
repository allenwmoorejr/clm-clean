"use client";import {useEffect,useMemo,useRef,useState} from 'react';import Link from 'next/link';export default function Watch(){const[d,sD]=useState(null as any);const[show,sShow]=useState(false);const[p,sP]=useState(0);const[resume,sR]=useState(null as any);const t=useRef(null as any);useEffect(()=>{fetch('/api/live').then(r=>r.json()).then(sD).catch(()=>sD({live:false}))},[]);const id=d?.live?d.videoId:d?.latestId;useEffect(()=>{if(!id)return;const raw=localStorage.getItem(`yt-progress-${id}`);if(raw){try{const v=JSON.parse(raw);if(typeof v.seconds==='number')sR(v.seconds)}catch{}}},[id]);useEffect(()=>{if(!show||!id)return;t.current=setInterval(()=>{sP(x=>{const n=x+1;if(n%5===0)localStorage.setItem(`yt-progress-${id}`,JSON.stringify({seconds:n,at:Date.now()}));return n})},1000);return()=>clearInterval(t.current)},[show,id]);const share=useMemo(()=>{if(!id)return'';const sec=resume??p;return `https://www.youtube.com/watch?v=${id}${sec>0?`&t=${sec}s`:''}`},[id,p,resume]);return(<section className='container py-16'><h1>{d?.live?'We’re Live Now':'Watch'}</h1><p className='text-white/70 mt-2'>{d?.live?'Thanks for worshiping with us!':'We’re not live right now — enjoy the latest message below.'}</p><div className='card overflow-hidden mt-8 relative'><div className='aspect-video relative'>{!show?(<><img src='/live-preview.jpg' className='w-full h-full object-cover'/><div className='absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-transparent'/><div className='absolute inset-0 flex items-end justify-start'><div className='p-4 md:p-6'><div className='flex flex-wrap gap-3'><a href={id?`https://www.youtube.com/watch?v=${id}`:`https://www.youtube.com/channel/${process.env.NEXT_PUBLIC_CHANNEL_ID??''}/live`} target='_blank' rel='noreferrer' className='btn-primary'>Watch on YouTube</a>{id&&(<button onClick={()=>sShow(true)} className='btn-ghost'>{resume&&resume>15?`Resume in Page (${Math.floor(resume/60)}:${String(resume%60).padStart(2,'0')})`:'Play in Page'}</button>)}{id&&resume&&resume>15&&(<a href={`https://www.youtube.com/watch?v=${id}&t=${resume}s`} target='_blank' rel='noreferrer' className='btn-ghost'>Resume on YouTube</a>)}</div></div></div></>):(<iframe className='w-full h-full' src={`https://www.youtube.com/embed/${id}?autoplay=1&modestbranding=1&rel=0`} title='CLM Live' allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share' allowFullScreen/>)}</div><div className='p-5 border-t border-white/10 flex items-center justify-between flex-wrap gap-3'><div className='flex items-center gap-4'><p className='text-white/90 font-medium'>{d?.live?'Live Stream':'Latest Sermon'}</p>{show&&<span className='text-white/60 text-sm'>Playing — {Math.floor(p/60)}:{String(p%60).padStart(2,'0')}</span>}</div><div className='flex items-center gap-3'>{id&&(<button onClick={()=>{navigator.clipboard?.writeText(share)}} className='btn-ghost' title='Copy a link that starts at the current time'>Copy timestamp link</button>)}<Link href='/sermons' className='btn-primary'>Browse Sermons</Link></div></div></div></section>)}